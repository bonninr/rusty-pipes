name: Windows ASIO Debug

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-asio-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # Install LLVM (Required for bindgen/cpal-asio)
      # The windows-latest runner has Chocolatey installed.
      - name: Install LLVM and Clang
        run: choco install llvm -y

      # Set Environment Variables for Bindgen
      # cpal requires LIBCLANG_PATH to find libclang.dll
      - name: Set LIBCLANG_PATH
        run: |
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      # Cache dependencies to speed up iteration
      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ./target
          key: win-asio-cargo-${{ hashFiles('Cargo.lock') }}

      # Patch Cargo.toml to enable ASIO
      - name: Enable ASIO feature in Cargo.toml
        shell: powershell
        run: |
          (Get-Content Cargo.toml) -replace 'features = \["jack"\]', 'features = ["jack", "asio"]' | Set-Content Cargo.toml
          Get-Content Cargo.toml | Select-String "cpal"

      # Build
      - name: Build with ASIO support
        run: cargo build --release --verbose --target x86_64-pc-windows-msvc